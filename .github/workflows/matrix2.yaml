
name: Iterate Environments2

on:
  workflow_dispatch:

jobs:

  print-vars:
    #needs: [setup, approve-deployments]
    strategy:
      fail-fast: false
      matrix:
        environment: ${{ fromJSON(needs.setup.outputs.environments) }}
    runs-on: ubuntu-latest
    environment: ${{ matrix.environment }}

    steps:
      - name: Print ENV (from environment vars)
        run: |
          echo "ENV=${{ vars.ENV }}"
          echo "SECRET=$(echo $SECRET | base64)"
        env:
          SECRET: ${{ secrets.SECRET }}

  # Generate environment list dynamically
  setup:
    runs-on: ubuntu-latest
    outputs:
      environments: ${{ steps.get-envs.outputs.matrix }}
    steps:
      - id: get-envs
        run: |
          # Get all environments from your repo
          ENVS='["env1","env2"]'
          echo "matrix=$ENVS" >> $GITHUB_OUTPUT

  # Approval job runs in parallel
  approve-deployments:
    needs: setup
    strategy:
      matrix:
        environment: ${{ fromJSON(needs.setup.outputs.environments) }}
    runs-on: ubuntu-latest
    steps:
      - name: Wait and Auto-Approve
        env:
          GH_TOKEN: ${{ secrets.ADMIN_PAT }}
        run: |
          # Wait for deployment to be pending
          sleep 10
          
          # Get pending deployments
          PENDING=$(gh api \
            /repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/pending_deployments \
            --jq '.[] | select(.environment.name=="${{ matrix.environment }}") | .environment.id')
          
          # Approve if pending
          echo "PENDING: $PENDING"
          if [ -n "$PENDING" ]; then
            gh api \
              --method POST \
              /repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/pending_deployments \
              -f environment_ids[]=$PENDING \
              -f state='approved' \
              -f comment='Auto-approved for scheduled terraform plan'
          fi


